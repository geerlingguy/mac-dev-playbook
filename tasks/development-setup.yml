---
- name: Ensure ~/Development directory exists.
  file:
    path: ~/Development
    state: directory
    mode: "0755"

- name: Configure git global user email.
  community.general.git_config:
    name: user.email
    scope: global
    value: "{{ work_email }}"

- name: Configure git global user name.
  community.general.git_config:
    name: user.name
    scope: global
    value: "{{ git_user_name }}"

- name: Check GitHub CLI authentication status.
  command: gh auth status
  register: gh_auth_status
  changed_when: false
  failed_when: false

- name: Prompt user to authenticate with GitHub CLI.
  when: gh_auth_status.rc != 0
  block:
    - name: Display GitHub authentication instructions.
      pause:
        prompt: |

          ╔════════════════════════════════════════════════════════════════╗
          ║  GitHub CLI authentication required                            ║
          ╠════════════════════════════════════════════════════════════════╣
          ║  Please open a NEW terminal window and run:                    ║
          ║                                                                ║
          ║    gh auth login                                               ║
          ║                                                                ║
          ║  Once authenticated, press ENTER here to continue...           ║
          ╚════════════════════════════════════════════════════════════════╝

    - name: Verify GitHub CLI authentication after prompt.
      command: gh auth status
      changed_when: false

- name: Configure gh git protocol to use https.
  command: gh config set git_protocol https
  changed_when: false

- name: Setup gh as git credential helper.
  command: gh auth setup-git
  changed_when: false

- name: Clone PRZM repository.
  git:
    repo: "{{ przm_repo }}"
    dest: ~/Development/przm
    version: "{{ przm_repo_version }}"
    accept_hostkey: true
  register: przm_clone_result
  ignore_errors: true

- name: Display clone result.
  debug:
    msg: "PRZM repository cloned successfully to ~/Development/przm"
  when: przm_clone_result is succeeded

- name: Add asdf initialization to shell config.
  blockinfile:
    path: ~/.zshrc
    marker: "# {mark} ANSIBLE MANAGED - asdf"
    block: |
      # asdf version manager
      source $(brew --prefix asdf)/libexec/asdf.sh
    insertafter: EOF

- name: Add pnpm completion to shell config.
  blockinfile:
    path: ~/.zshrc
    marker: "# {mark} ANSIBLE MANAGED - pnpm completion"
    block: |
      # pnpm shell completion
      source <(pnpm completion zsh)
    insertafter: EOF

- name: Add ~/.local/bin to PATH for Claude Code and other local binaries.
  blockinfile:
    path: ~/.zshrc
    marker: "# {mark} ANSIBLE MANAGED - local bin path"
    block: |
      # Add ~/.local/bin to PATH (for Claude Code native installation, etc.)
      export PATH="$HOME/.local/bin:$PATH"
    insertafter: EOF

- name: Add asdf shims to PATH for npm/pnpm/npx availability.
  blockinfile:
    path: ~/.zshrc
    marker: "# {mark} ANSIBLE MANAGED - asdf shims"
    block: |
      # Ensure asdf shims are in PATH for npm, pnpm, npx, node
      export PATH="$HOME/.asdf/shims:$PATH"
    insertafter: EOF

- name: Run claude install to configure Claude Code.
  shell: |
    export PATH="$HOME/.local/bin:/opt/homebrew/bin:$PATH"
    if command -v claude &> /dev/null; then
      claude install --yes 2>/dev/null || true
    fi
  args:
    executable: /bin/zsh
  changed_when: false
  ignore_errors: true

- name: Check if przm repo exists.
  stat:
    path: ~/Development/przm/.tool-versions
  register: przm_tool_versions

- name: Add asdf plugins for nodejs and pnpm.
  shell: |
    source $(brew --prefix asdf)/libexec/asdf.sh
    asdf plugin add nodejs || true
    asdf plugin add pnpm || true
  args:
    executable: /bin/zsh
  changed_when: false
  when: przm_tool_versions.stat.exists

- name: Install tools from .tool-versions via asdf.
  shell: |
    source $(brew --prefix asdf)/libexec/asdf.sh
    cd ~/Development/przm
    asdf install
  args:
    executable: /bin/zsh
  when: przm_tool_versions.stat.exists

- name: Get GitHub token from gh CLI for MCP server.
  command: gh auth token
  register: gh_token_result
  changed_when: false
  failed_when: false

- name: Check if .env.local exists in przm repo.
  stat:
    path: ~/Development/przm/.env.local
  register: przm_env_local

- name: Create .env.local with GitHub PAT if it doesn't exist.
  copy:
    dest: ~/Development/przm/.env.local
    content: |
      # GitHub Personal Access Token for MCP server
      GITHUB_PERSONAL_ACCESS_TOKEN={{ gh_token_result.stdout }}
    mode: "0600"
  when:
    - gh_token_result.rc == 0
    - gh_token_result.stdout | length > 0
    - not przm_env_local.stat.exists

- name: Add GitHub PAT to existing .env.local if not present.
  lineinfile:
    path: ~/Development/przm/.env.local
    line: "GITHUB_PERSONAL_ACCESS_TOKEN={{ gh_token_result.stdout }}"
    regexp: "^GITHUB_PERSONAL_ACCESS_TOKEN="
    state: present
    mode: "0600"
  when:
    - gh_token_result.rc == 0
    - gh_token_result.stdout | length > 0
    - przm_env_local.stat.exists

- name: Open VSCode with PRZM repository.
  command: open -a "Visual Studio Code" ~/Development/przm
  changed_when: false
  when: open_vscode_after_clone

- name: Open OrbStack.
  command: open -a "OrbStack"
  changed_when: false
  when: open_orbstack_after_setup

- name: Open Granola.
  command: open -a "Granola"
  changed_when: false
  when: open_granola_after_setup

- name: Open Claude.
  command: open -a "Claude"
  changed_when: false
  when: open_claude_after_setup

- name: Open 1Password.
  command: open -a "1Password"
  changed_when: false
  when: open_1password_after_setup
