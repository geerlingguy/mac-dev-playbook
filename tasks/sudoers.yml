---
# If the user installs GNU sed through homebrew the path is different.
- name: Register path to sed.
  command: which sed
  register: sed_which_result
  changed_when: false
  when: sed_path is undefined

- name: Define sed_path variable.
  set_fact:
    sed_path: "{{ sed_which_result.stdout }}"
  when: sed_path is undefined

- name: Add Vagrant config to end of sudoers file
  blockinfile:
    path: /etc/sudoers
    marker: "# {mark} Vagrant sudoers config"
    insertafter: EOF
    validate: '/usr/sbin/visudo -cf %s'
    block: |
      Cmnd_Alias VAGRANT_EXPORTS_ADD = /usr/bin/tee -a /etc/exports
      Cmnd_Alias VAGRANT_NFSD = /sbin/nfsd restart
      Cmnd_Alias VAGRANT_EXPORTS_REMOVE = {{ sed_path }} -E -e /*/ d -ibak /etc/exports
      Cmnd_Alias VAGRANT_HOSTS_ADD = /bin/sh -c echo "*" >> /etc/hosts
      Cmnd_Alias VAGRANT_HOSTS_REMOVE = {{ sed_path }} -i -e /*/ d /etc/hosts
      %admin ALL=(root) NOPASSWD: VAGRANT_EXPORTS_ADD, VAGRANT_NFSD, VAGRANT_EXPORTS_REMOVE, VAGRANT_HOSTS_ADD, VAGRANT_HOSTS_REMOVE
  become: yes
